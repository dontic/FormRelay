# ===========================================================================
#  FormRelay - Single-File Docker Compose Deployment
# ===========================================================================
#
#  Quick Start:
#    1. Replace the image name below with your own Docker registry image
#    2. Change DJANGO_SECRET_KEY to a unique random string
#    3. Run: docker compose up -d
#
#  To customize any setting, either:
#    - Edit the default values directly in this file, or
#    - Create a .env file next to this file to override specific variables
#      (Docker Compose automatically loads .env files)
#
#  Production checklist:
#    - [ ] Set a strong, unique DJANGO_SECRET_KEY
#    - [ ] Set DJANGO_DEBUG=False
#    - [ ] Update DJANGO_ALLOWED_HOSTS and DJANGO_ALLOWED_ORIGINS for your domain
#    - [ ] Change POSTGRES_PASSWORD to something secure
#    - [ ] Update the image name to your registry
# ===========================================================================


# ---------------------------------------------------------------------------
# Django App Template (YAML Anchor)
# ---------------------------------------------------------------------------
# Shared configuration for Django-based services (web server + worker).
# Uses YAML anchors to avoid duplication.
x-django-app: &django-app
  restart: unless-stopped
  image: dontic/formrelay:latest
  environment: &django-env
    # ── Django Core ──────────────────────────────────────────────────────
    DJANGO_SECRET_KEY: change-me
    DJANGO_DEBUG: False
    LOGGING_LOG_LEVEL: INFO
    DJANGO_ALLOWED_ORIGINS: https://mywebsite.com
    DJANGO_ALLOWED_HOSTS: mydjangodomain.com
    DJANGO_CSRF_COOKIE_DOMAIN: mydjangodomain.com
    DJANGO_SESSION_COOKIE_DOMAIN: mydjangodomain.com
    # ── PostgreSQL (internal defaults — no need to change unless using an external PostgreSQL server) ───────────────
    POSTGRES_DB_NAME: django
    POSTGRES_USER: django
    POSTGRES_PASSWORD: django
    POSTGRES_HOST: postgres
    POSTGRES_PORT: "5432"
    # ── Redis (internal defaults — no need to change unless using an external Redis server) ────────────────────
    REDIS_HOST: redis
    REDIS_PORT: "6379"
    REDIS_DB: 0
  volumes:
    # Media files volume — shared across all Django services
    - media:/app/backend/media


services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  # Primary relational database for the application.
  # Data is persisted to a named volume for durability.
  # Comment out this service if using an external PostgreSQL server.
  postgres:
    restart: unless-stopped
    image: postgres:16-bullseye
    environment:
      POSTGRES_DB: django
      POSTGRES_USER: django
      POSTGRES_PASSWORD: django
    volumes:
      - postgresdata:/var/lib/postgresql/data
    # Uncomment to expose PostgreSQL port for external access (e.g., DB GUI tools)
    # ports:
    #   - "5432:5432"

  # ---------------------------------------------------------------------------
  # Redis Cache & Message Broker
  # ---------------------------------------------------------------------------
  # In-memory store used as cache backend and Celery message broker.
  # Comment out this service if using an external Redis server.
  redis:
    restart: unless-stopped
    image: redis:7.2.0-alpine
    # Uncomment to expose Redis port for external access
    # ports:
    #   - "6379:6379"

  # ---------------------------------------------------------------------------
  # Django Web Application
  # ---------------------------------------------------------------------------
  # Main application server (Gunicorn). Handles HTTP requests, REST API,
  # and runs migrations + static file collection on startup.
  django:
    <<: *django-app
    entrypoint: /app/backend/docker/entrypoint-django.sh
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_started
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/ht/startup-probe/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ---------------------------------------------------------------------------
  # Celery Worker
  # ---------------------------------------------------------------------------
  # Processes background tasks (emails, notifications, data processing).
  # Waits for Django to be healthy to ensure migrations are complete.
  worker:
    <<: *django-app
    entrypoint: /app/backend/docker/entrypoint-worker.sh
    depends_on:
      postgres:
        condition: service_started
      django:
        condition: service_healthy
      redis:
        condition: service_started

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy
  # ---------------------------------------------------------------------------
  # Entry point for HTTP traffic. Proxies to Django and serves media files.
  # Config is defined inline below
  nginx:
    image: nginx:1.28
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - media:/app/backend/media:ro
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
    depends_on:
      - django


# ---------------------------------------------------------------------------
# Nginx Configuration
# ---------------------------------------------------------------------------
configs:
  nginx_conf:
    content: |
      events {}

      http {
          server {
              listen 80;

              location /media/ {
                  alias /app/backend/media/;
                  autoindex off;
              }

              location / {
                  proxy_pass http://django:8000;
                  proxy_set_header Host $$host;
                  proxy_set_header X-Real-IP $$remote_addr;
              }
          }
      }


# ---------------------------------------------------------------------------
# Named Volumes
# ---------------------------------------------------------------------------
volumes:
  postgresdata:
  media:
